<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp QR Code</title>
    <link rel="icon" href="waicon.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css.css">
    <script src="/socket.io/socket.io.js"></script>
    <script>
      window.onload = async () => {  
        const socket = io();
   
        const response = await fetch('/clients');
        const clients = await response.json();
        for (const clientId in clients) {
            const clientInfo = document.createElement('div');
            clientInfo.classList.add('client');
            clientInfo.innerText = `Client ID: ${clientId}, Status: ${clients[clientId].status}, Since: ${clients[clientId].time}`;
            document.getElementById('clients').appendChild(clientInfo);
        }

        document.getElementById('initializeClientBtn').onclick = async () => {
            const clientId = `client_${document.querySelectorAll('.client').length + 1}`;          
            document.getElementById('loadingSpinner').style.display = 'block';            
            await fetch('/initializeClient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ clientId })
            });
        };

        socket.on('qr', (qr) => {
        
            document.getElementById('loadingSpinner').style.display = 'none';            
            const qrCodeContainer = document.getElementById('qrcode');
            const img = document.createElement('img');
            img.src = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(qr.qr)}&size=200x200`;
            img.classList.add('img-fluid');  
            qrCodeContainer.innerHTML = '';  
            qrCodeContainer.appendChild(img);
            const clientInfo = document.createElement('div');
            clientInfo.classList.add('client');
            clientInfo.innerText = `Client ID: ${qr.clientId}`;
            document.getElementById('clients').appendChild(clientInfo);
        });

        socket.on('userLoggedIn', (data) => { 
            const notificationArea = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.classList.add('alert', 'alert-info');
            notification.innerText = `User ${data.number} is currently online since ${data.time}`;
            notificationArea.appendChild(notification);
        });

        socket.on('userDisconnected', (data) => {
            const notificationArea = document.getElementById('notifications');
            const notification = document.createElement('div');
            notification.classList.add('alert', 'alert-danger');
            notification.innerText = `User ${data.number} has disconnected.`;
            notificationArea.appendChild(notification);
        });
    };
    </script>
</head>
<body>
    <div class="container">
        <h2 class="m-5">WhatsApp Client Manager</h2>
        <button id="initializeClientBtn" class="btn btn-primary">Initialize New Client</button>
        <div id="loadingSpinner" class="spinner-border text-primary" role="status" style="display: none;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <div id="clients" class="mt-3"></div>
        <div id="qrcode" class="text-center mt-3"></div>
        <div id="notifications" class="mt-3"></div>
    </div>
</body>
</html>
